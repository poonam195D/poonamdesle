# ----------- STAGE 1: Builder ------------
FROM ubuntu:24.04 as builder

ENV DEBIAN_FRONTEND=noninteractive
ENV GROOVY_VERSION=4.0.26

RUN apt-get update && apt-get install -y \
    curl \
    unzip \
    python3-pip \
    pipx \
    && apt-get clean

# Install Groovy
RUN curl -fSL "https://dlcdn.apache.org/groovy/${GROOVY_VERSION}/distribution/apache-groovy-binary-${GROOVY_VERSION}.zip" -o /tmp/groovy.zip && \
    unzip /tmp/groovy.zip -d /opt && \
    ln -s /opt/groovy-${GROOVY_VERSION} /opt/groovy

# Install awscli using pipx
#RUN pipx install awscli --include-deps && \
#    ln -s /root/.local/bin/aws /usr/local/bin/aws

# ----------- STAGE 2: Final Image ------------
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    openjdk-17-jdk \
    git \
    sudo \
    openssh-server \
    docker.io \
    vim \
    python3-pip \
    pipx \
    curl \
    unzip \
    rsync \
    bc \
    groff-base \
    apt-transport-https \
    && apt-get clean

# Copy Groovy and awscli from builder
COPY --from=builder /opt/groovy /opt/groovy
COPY --from=builder /root/.local /root/.local
ENV PATH="/opt/groovy/bin:/root/.local/bin:$PATH"
ENV GROOVY_HOME=/opt/groovy

# Create jenkins user
RUN useradd -m -s /bin/bash jenkins && \
    echo "jenkins ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    usermod -aG docker jenkins

# Prepare Jenkins home and agent
RUN mkdir -p /home/jenkins/agent && \
    chown -R jenkins:jenkins /home/jenkins

# --- Install kubectl ---
RUN curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl" && \
    chmod +x ./kubectl && \
    mv ./kubectl /usr/local/bin/kubectl

# --- Install aws-iam-authenticator ---
RUN curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.16.8/2020-04-16/bin/linux/amd64/aws-iam-authenticator && \
    chmod +x ./aws-iam-authenticator && \
    mv ./aws-iam-authenticator /usr/local/bin/aws-iam-authenticator

# --- Install eksctl ---
RUN curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp && \
    mv /tmp/eksctl /usr/local/bin/eksctl

# --- Install Helm ---
RUN curl https://helm.baltorepo.com/organization/signing.asc | apt-key add - && \
    echo "deb https://baltocdn.com/helm/stable/debian/ all main" | tee /etc/apt/sources.list.d/helm-stable-debian.list && \
    apt-get update && \
    apt-get install -y helm && \
    apt-get clean

# Install awscli using pipx
RUN pipx install awscli --include-deps && \
    ln -s /root/.local/bin/aws /usr/local/bin/aws

# Copy entrypoint script
COPY entrypoint.sh /home/jenkins/entrypoint.sh
RUN chmod +x /home/jenkins/entrypoint.sh

USER jenkins
WORKDIR /home/jenkins/agent

ENTRYPOINT ["/home/jenkins/entrypoint.sh"]

# Optionally specify the default command
# CMD ["dockerd"]
